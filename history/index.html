<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜è€ƒå†å²ç‰¹è®­ï¼ˆæ‰‹æœºä¸“ç”¨ç‰ˆï¼‰</title>
    <!-- å¼•å…¥ EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #16a34a;
            --success-bg: #dcfce7;
            --danger: #dc2626;
            --danger-bg: #fee2e2;
            --warning: #ca8a04;
            --warning-bg: #fef9c3;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --text-main: #111827;
            --text-sub: #6b7280;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--gray-100);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            background-color: var(--gray-800);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .progress-container {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .master-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .progress-bar-bg {
            width: 60px;
            height: 6px;
            background-color: #4b5563;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #facc15;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            padding: 1rem;
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 80px; /* ä¸ºåº•éƒ¨æŒ‰é’®ç•™ç©ºé—´ */
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .card-header {
            background-color: var(--gray-50);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tag {
            background-color: #dbeafe;
            color: #1e40af;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            display: none; /* é»˜è®¤éšè—ï¼Œæœ‰çŠ¶æ€æ‰æ˜¾ç¤º */
        }
        .status-mastered {
            background-color: var(--success-bg);
            color: var(--success);
            display: inline-block;
        }
        .status-review {
            background-color: var(--danger-bg);
            color: var(--danger);
            display: inline-block;
        }

        .card-body {
            padding: 1.25rem;
        }

        .q-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .q-content {
            background-color: var(--gray-50);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            margin-bottom: 1rem;
        }

        /* è¯Šæ–­æ¡† */
        .diagnosis-box {
            background-color: var(--danger-bg);
            border-left: 4px solid var(--danger);
            padding: 1rem;
            border-radius: 0 4px 4px 0;
            margin-top: 1rem;
        }

        .diagnosis-title {
            color: #991b1b;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        /* è¾“å…¥åŒº */
        textarea {
            width: 100%;
            height: 200px;
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            margin-bottom: 1rem;
            -webkit-appearance: none;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* æŒ‰é’® */
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.8;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-next {
            background-color: var(--gray-800);
            color: white;
        }

        .btn-outline {
            background-color: white;
            border: 1px solid var(--gray-200);
            color: var(--gray-700);
            margin-top: 1rem;
        }

        /* è¯„ä»·æŒ‰é’®ç»„ */
        .eval-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px dashed var(--gray-200);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        /* å¯¹æ¯”åŒºåŸŸ */
        .review-section {
            display: none;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .comparison-grid {
            display: grid;
            gap: 1rem;
        }

        .answer-box {
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.95rem;
            white-space: pre-line;
        }

        .old-answer {
            background-color: var(--danger-bg);
            border: 1px solid #fecaca;
            color: #7f1d1d;
        }

        .new-answer {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e3a8a;
        }

        .std-box {
            background-color: white;
            border: 1px solid var(--success);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .std-header {
            background-color: var(--success);
            color: white;
            padding: 10px 15px;
            font-weight: bold;
        }

        .std-body {
            padding: 1.25rem;
        }

        .highlight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .highlight-list li {
            padding-left: 1.5rem;
            position: relative;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--gray-700);
        }

        .highlight-list li::before {
            content: "â€¢";
            color: var(--warning);
            font-weight: bold;
            font-size: 1.5rem;
            position: absolute;
            left: 0;
            top: -5px;
        }

        /* æ¬¢è¿é¡µ */
        #welcome-screen {
            text-align: center;
            padding: 2rem 1rem;
        }
        
        .welcome-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        /* è®¾ç½®æ¡† */
        .setting-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
            text-align: left;
        }

        .setting-label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .input-num {
            width: 100%;
            padding: 10px;
            font-size: 1.1rem;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            text-align: center;
        }

        /* ç»“ç®—é¡µ */
        #completion-screen {
            text-align: center;
            padding: 1rem;
        }

        .summary-list {
            text-align: left;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #e5e7eb;
        }

        .summary-item {
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .email-status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.9rem;
            background: #f3f4f6;
        }

        .hidden {
            display: none !important;
        }
        
        .cloud-status {
            font-size: 0.7rem;
            color: #9ca3af;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <h1>ğŸ“œ å†å²ç‰¹è®­</h1>
            <div class="progress-container">
                <span class="master-count" id="master-count">å·²æŒæ¡: 0</span>
                <span id="progress-text">1/--</span>
                <div class="progress-bar-bg">
                    <div id="progress-bar" class="progress-bar-fill"></div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        
        <!-- æ¬¢è¿é¡µ -->
        <div id="welcome-screen">
            <div class="welcome-icon">ğŸ¯</div>
            <h2 style="margin-bottom: 0.5rem;">é«˜è€ƒå†å² Â· å¼±é¡¹å®šå‘è¯Šç–—</h2>
            <p style="color: var(--text-sub); margin-bottom: 2rem;">
                ä¸“ä¸ºæ‰‹æœºä¼˜åŒ–ã€‚<br>
                æœ¬åœ°è‡ªåŠ¨è®°å½•åšé¢˜è¿›åº¦ã€‚<br>
                <span id="cloud-indicator">â˜ï¸ æ•°æ®å°†åŒæ­¥åˆ°äº‘ç«¯</span>
            </p>

            <div class="setting-box">
                <label class="setting-label">ğŸ“… ä»Šæ—¥è®¡åˆ’åˆ·é¢˜æ•°ï¼š</label>
                <input type="number" id="daily-goal-input" class="input-num" value="5" min="1" max="50">
                <div style="font-size:0.8rem; color:#6b7280; margin-top:5px;">å®Œæˆåå°†è‡ªåŠ¨å‘é€æŠ¥å‘Šåˆ°é‚®ç®±</div>
            </div>

            <button onclick="window.startPractice()" class="btn btn-primary">å¼€å§‹ç‰¹è®­</button>
            <p style="margin-top:1rem; font-size:0.8rem; color:#9ca3af; cursor:pointer;" onclick="window.clearData()">[é‡ç½®æ‰€æœ‰è®°å½•]</p>
        </div>

        <!-- ç­”é¢˜é¡µ -->
        <div id="practice-screen" class="hidden">
            
            <!-- é¢˜ç›®å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <span class="tag" id="q-year">å¹´ä»½</span>
                        <span id="status-badge" class="status-badge"></span>
                    </div>
                    <span class="score-tag" id="q-score-info">å¾—åˆ†ä¿¡æ¯</span>
                </div>
                <div class="card-body">
                    <h3 class="q-title" id="q-title">é¢˜ç›®</h3>
                    <div class="q-content" id="q-content">å†…å®¹</div>
                    
                    <div class="diagnosis-box">
                        <div class="diagnosis-title">âš ï¸ ä¸Šæ¬¡çš„è‡´å‘½ä¼¤</div>
                        <div style="font-size: 0.9rem;" id="q-diagnosis"></div>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒº -->
            <div id="input-section" class="card" style="padding: 1rem;">
                <label style="display:block; font-weight:bold; margin-bottom:0.5rem;">ä½ çš„æ–°å›ç­”ï¼š</label>
                <textarea id="user-input" placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ..."></textarea>
                <div style="display: flex; gap: 12px;">
                    <button onclick="window.skipQuestion()" class="btn" style="background: white; border: 1px solid #e5e7eb; color: #6b7280; flex: 1;">è·³è¿‡ â†·</button>
                    <button onclick="window.submitAnswer()" class="btn btn-primary" style="flex: 2;">æäº¤å¹¶å¯¹æ¯” â”</button>
                </div>
            </div>

            <!-- å¤ç›˜åŒº -->
            <div id="review-section" class="review-section">
                
                <div class="comparison-grid">
                    <div>
                        <div style="font-weight:bold; color:#991b1b; margin-bottom:5px;">âŒ ä½ çš„æ—§å›ç­”</div>
                        <div class="answer-box old-answer" id="old-answer-display"></div>
                    </div>
                    <div>
                        <div style="font-weight:bold; color:#1e40af; margin-bottom:5px;">âœï¸ ä½ çš„æ–°å›ç­”</div>
                        <div class="answer-box new-answer" id="new-answer-display"></div>
                    </div>
                </div>

                <!-- æ ‡å‡†ç­”æ¡ˆ -->
                <div class="std-box">
                    <div class="std-header">â˜… æ ‡å‡†ç­”æ¡ˆ & é€»è¾‘</div>
                    <div class="std-body">
                        <div style="background:#fef9c3; padding:10px; border-radius:4px; margin-bottom:1rem;">
                            <strong style="color:#854d0e; font-size:0.8rem; display:block; margin-bottom:4px;">é˜…å·äººè§†è§’</strong>
                            <div id="examiner-notes" style="font-size:0.9rem;"></div>
                        </div>

                        <div style="margin-bottom:1rem;">
                            <strong style="color:#166534; font-size:0.8rem; display:block; margin-bottom:4px;">å‚è€ƒç­”æ¡ˆ</strong>
                            <div id="std-answer-display" style="font-size:0.95rem; color:#1f2937;"></div>
                        </div>

                        <hr style="border:0; border-top:1px solid #e5e7eb; margin:1rem 0;">

                        <div>
                            <strong style="color:#4338ca; font-size:0.8rem; display:block; margin-bottom:4px;">ğŸš€ æåˆ†å…³é”®</strong>
                            <ul id="key-takeaways" class="highlight-list"></ul>
                        </div>
                    </div>
                </div>
                
                <!-- è‡ªè¯„åŒºåŸŸ -->
                <div class="card" style="margin-top: 1.5rem; padding: 1.25rem;">
                    <div style="text-align: center; font-weight: bold; margin-bottom: 1rem;">è‡ªæˆ‘è¯„ä»·ï¼šè¿™é“é¢˜ç°åœ¨æŒæ¡äº†å—ï¼Ÿ</div>
                    <div class="eval-grid" style="margin-top: 0; border: none; padding-top: 0;">
                        <button onclick="window.markResult(false)" class="btn btn-danger">ğŸ”´ éœ€å¤ä¹ </button>
                        <button onclick="window.markResult(true)" class="btn btn-success">âœ… å·²æŒæ¡</button>
                    </div>
                    <div id="upload-status" class="cloud-status" style="text-align:center;"></div>
                </div>

                <div style="margin-top: 1.5rem;">
                    <button onclick="window.nextQuestion()" class="btn btn-next" id="btn-next-step">è·³è¿‡è¯„ä»·è¿›å…¥ä¸‹ä¸€é¢˜ â”</button>
                </div>

            </div>

        </div>

        <!-- ç»“ç®—é¡µ -->
        <div id="completion-screen" class="hidden">
            <div class="welcome-icon">ğŸ‰</div>
            <h2>ä»Šæ—¥ç‰¹è®­å®Œæˆï¼</h2>
            <p>å·²å®Œæˆä»Šæ—¥è®¾å®šçš„ç›®æ ‡ã€‚</p>
            
            <div class="summary-list" id="session-summary-list">
                <!-- JS ä¼šå¡«å……è¿™é‡Œ -->
            </div>

            <div id="email-report-status" class="email-status">
                ğŸ“¨ æ­£åœ¨ç”Ÿæˆé‚®ä»¶æŠ¥å‘Š...
            </div>

            <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">è¿”å›é¦–é¡µ</button>
        </div>

    </div>

    <script type="module">
        // ----------------------------------------------------
        // FIREBASE é…ç½®åŒºåŸŸ
        // ----------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // é‚®ä»¶é…ç½®
        const EMAIL_CONFIG = {
            serviceID: "service_j2ak28v",
            templateID: "template_ol3ws9o",
            publicKey: "bGbqCw1wlTrkCwfFo"
        };

        // åˆå§‹åŒ– EmailJS
        (function() {
            if(window.emailjs) {
                emailjs.init(EMAIL_CONFIG.publicKey);
            } else {
                console.error("EmailJS SDK failed to load");
            }
        })();

        const firebaseConfig = {
          apiKey: "AIzaSyCb3qEBV8BYmkP3qjEAqlpGkM0kz-Lr7PE",
          authDomain: "history-app-6e0f3.firebaseapp.com",
          projectId: "history-app-6e0f3",
          storageBucket: "history-app-6e0f3.firebasestorage.app",
          messagingSenderId: "1065684045418",
          appId: "1:1065684045418:web:3f99560b0e51decb0c0413",
          measurementId: "G-PELR13Y7YS"
        };

        // åˆå§‹åŒ– Firebase
        let db = null;
        let auth = null;
        let userId = "guest";
        let isCloudEnabled = false;

        if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                signInAnonymously(auth).then((userCredential) => {
                    userId = userCredential.user.uid;
                    isCloudEnabled = true;
                    console.log("äº‘ç«¯è¿æ¥æˆåŠŸï¼Œç”¨æˆ·ID:", userId);
                    document.getElementById('cloud-indicator').innerText = "â˜ï¸ äº‘ç«¯å·²è¿æ¥";
                    document.getElementById('cloud-indicator').style.color = "#16a34a";
                }).catch((error) => {
                    console.error("ç™»å½•å¤±è´¥:", error);
                });
            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®:", e);
            }
        }

        // ----------------------------------------------------
        // æ ¸å¿ƒé€»è¾‘
        // ----------------------------------------------------

        // é¢˜ç›®æ•°æ®
        const questions = [
            {
                id: 1,
                year: "2015 é«˜è€ƒå†å²",
                title: "ç¬¬13é¢˜ï¼šå„’å­¦çš„å‘å±•ï¼ˆæ±‰ä»£ vs å®‹ä»£ï¼‰",
                content: `<strong>ï¼ˆ1ï¼‰æŒ‡å‡ºæ±‰ä»£å„’å­¦ä¸å­”å­Ÿå„’å­¦çš„ä¸åŒä¹‹å¤„ï¼Œå¹¶æ¦‚æ‹¬å®‹ä»£ç†å­¦åœ¨å“ªäº›æ–¹é¢å¯¹å„’å­¦æœ‰æ‰€å‘å±•ã€‚</strong><br><br>
                          <strong>ï¼ˆ2ï¼‰æŒ‡å‡ºéŸ©æ„ˆã€åº·æœ‰ä¸ºå…³äºå„’å­¦è®¤è¯†çš„å…±é€šä¹‹å¤„ã€‚</strong><br><br>
                          <strong>ï¼ˆ3ï¼‰æˆ‘ä»¬åº”å½“ä»¥ä»€ä¹ˆæ ·çš„æ€åº¦å¯¹å¾…å­”å­ä¸å„’å­¦ï¼Ÿ</strong>`,
                oldAnswer: `ï¼ˆ1ï¼‰å­”å­Ÿæ˜¯ä»æ”¿ï¼Œæ°‘æœ¬æ•™åŒ–ï¼›æ±‰å„’æ˜¯çš‡æƒç¥æˆã€‚å‘å±•ï¼šé‡è§†å„’å®¶ç»å…¸\nï¼ˆ2ï¼‰å€Ÿå„’å®¶å½±å“ä¸ºç°å®æœåŠ¡ï¼›é‡è§†å­”å­Ÿç»å…¸\nï¼ˆ3ï¼‰æ€åº¦ï¼šå–å…¶ç²¾åï¼Œå»å…¶ç³Ÿç²•ï¼›è¦ç”¨ç†æ€§çš„çœ¼å…‰çœ‹å¾…å‰äºº`,
                scoreInfo: "æ—§å¾—åˆ†ï¼šå¤±åˆ†ä¸¥é‡",
                diagnosis: `1. <strong>è¯æ±‡åŒ®ä¹ï¼š</strong> å®‹ä»£ç†å­¦æ ¸å¿ƒåœ¨äº<span style="color:red">æ€è¾¨åŒ–ã€å“²å­¦åŒ–</span>ã€‚<br>
                            2. <strong>æ¼ç‚¹ï¼š</strong> æ±‰ä»£å„’å­¦å¸æ”¶äº†æ³•å®¶ã€é“å®¶æ€æƒ³ï¼ˆå¤§ä¸€ç»Ÿï¼‰ã€‚<br>
                            3. <strong>æ¦‚å¿µç¼ºå¤±ï¼š</strong> æœªæåŠâ€œå­˜å¤©ç†ï¼Œç­äººæ¬²â€ã€‚`,
                examinerNotes: [
                    "æ±‰ä»£å„’å­¦ï¼šå¤§ä¸€ç»Ÿã€å¤©äººæ„Ÿåº”ã€‚",
                    "å®‹ä»£ç†å­¦ï¼šæ€è¾¨åŒ–ã€å“²å­¦åŒ–ã€ä¼¦ç†çº²å¸¸ã€‚",
                    "ä½ çš„æ—§å›ç­”ç¬¬2é—®æŠ“å¾—å‡†ï¼Œä½†ç¬¬1é—®å¤ªç¬¼ç»Ÿã€‚"
                ],
                stdAnswer: `<strong>ï¼ˆ1ï¼‰ä¸åŒï¼š</strong> å­”å­Ÿè®²â€œä»/ç¤¼/æ°‘æœ¬â€ï¼›æ±‰å„’è®²â€œå¤§ä¸€ç»Ÿ/å¤©äººæ„Ÿåº”/å›æƒç¥æˆâ€ï¼ˆå¸çº³æ³•é“é˜´é˜³ï¼‰ã€‚<br>
                            <strong>å‘å±•ï¼š</strong> å¸æ”¶ä½›é“æ€æƒ³ï¼›ä½¿å„’å­¦<strong>æ€è¾¨åŒ–ã€å“²å­¦åŒ–</strong>ï¼›æå‡ºâ€œå­˜å¤©ç†ï¼Œç­äººæ¬²â€ã€‚<br><br>
                            <strong>ï¼ˆ2ï¼‰å…±é€šï¼š</strong> å›å½’åŸå…¸ï¼ˆå¦å®šåä¸–æµå˜ï¼‰ï¼›æ‰˜å¤æ”¹åˆ¶ï¼›æœåŠ¡äºç°å®æ”¿æ²»ã€‚<br><br>
                            <strong>ï¼ˆ3ï¼‰æ€åº¦ï¼š</strong> æ‰¹åˆ¤ç»§æ‰¿ï¼›ç»“åˆæ—¶ä»£åˆ›æ–°ã€‚`,
                takeaways: [
                    "æåˆ°å®‹æ˜ç†å­¦ï¼Œå¿…é¡»åå°„å‡ºå…³é”®è¯ï¼š<strong>æ€è¾¨åŒ–ã€å“²å­¦åŒ–ã€å­˜å¤©ç†ç­äººæ¬²</strong>ã€‚",
                    "å¯¹æ¯”é¢˜æ³¨æ„ï¼šAæœ‰Bæ— ï¼ŒBæœ‰Aæ— ã€‚"
                ]
            },
            {
                id: 2,
                year: "2015 é«˜è€ƒå†å²",
                title: "ç¬¬14é¢˜ï¼šç§‘å­¦æŠ€æœ¯ä¸ç”Ÿäº§åŠ›å…¬å¼ï¼ˆè®ºè¿°é¢˜ï¼‰",
                content: `<strong>è¿ç”¨ä¸–ç•Œè¿‘ç°ä»£å²çš„å²å®ï¼Œå¯¹å…¬å¼ï¼ˆç”Ÿäº§åŠ›=ç§‘å­¦æŠ€æœ¯Ã—ï¼ˆåŠ³åŠ¨åŠ›+åŠ³åŠ¨å·¥å…·+åŠ³åŠ¨å¯¹è±¡+ç”Ÿäº§ç®¡ç†ï¼‰ï¼‰è¿›è¡Œæ¢è®¨ã€‚</strong>`,
                oldAnswer: `ï¼ˆ1ï¼‰1ç¬¬ä¸€æ¬¡å·¥ä¸šé©å‘½æé«˜ç¤¾ä¼šç”Ÿäº§åŠ›ï¼Œå»ºè®¾å·¥ä¸šåˆ¶åº¦\nï¼ˆ2ï¼‰2ç¬¬äºŒæ¬¡å·¥ä¸šé©å‘½å‡ºç°å„æ–­ç»„ç»‡è·¨å›½å…¬å¸ï¼Œæé«˜ç”Ÿäº§æ°´å¹³\nï¼ˆ3ï¼‰3ç¬¬ä¸‰æ¬¡ç§‘æŠ€é©å‘½ï¼Œæé«˜ç”Ÿäº§æ•ˆç‡ï¼Œç¤¾ä¼šè¿›å…¥ä¿¡æ¯æ—¶ä»£`,
                scoreInfo: "æ—§å¾—åˆ†ï¼šé€»è¾‘è„±èŠ‚",
                diagnosis: `1. <strong>é€»è¾‘æ–­å±‚ï¼š</strong> æœªæ‰£ä½å…¬å¼é‡Œçš„å…·ä½“é¡¹ï¼ˆåŠ³åŠ¨åŠ›ã€å·¥å…·ã€ç®¡ç†ï¼‰ã€‚<br>
                            2. <strong>ç¼ºå°‘ç»“æ„ï¼š</strong> ç¼ºå°‘æ˜ç¡®çš„è§‚ç‚¹å¥å’Œæ€»ç»“å¥ã€‚`,
                examinerNotes: [
                    "è®ºæ®é€‰æ‹©æ­£ç¡®ï¼ˆä¸‰æ¬¡é©å‘½ï¼‰ã€‚",
                    "ç¼ºä¹ä¸å…¬å¼è¦ç´ ï¼ˆå·¥å…·ã€ç®¡ç†ï¼‰çš„å¯¹åº”åˆ†æã€‚",
                    "ç¼ºè§‚ç‚¹å¥ã€‚"
                ],
                stdAnswer: `<strong>è§‚ç‚¹ï¼š</strong> ç§‘æŠ€æ˜¯ç¬¬ä¸€ç”Ÿäº§åŠ›ï¼Œå¯¹å„è¦ç´ æœ‰æ”¾å¤§æ•ˆåº”ã€‚<br>
                            <strong>è®ºè¯ï¼š</strong><br>
                            1. <strong>å·¥å…·ï¼š</strong> è’¸æ±½æœºâ†’ç”µæ°”åŒ–â†’è‡ªåŠ¨åŒ–ã€‚<br>
                            2. <strong>ç®¡ç†ï¼š</strong> å·¥å‚åˆ¶åº¦â†’å„æ–­ç»„ç»‡â†’ç°ä»£ä¼ä¸šç®¡ç†ã€‚<br>
                            3. <strong>åŠ³åŠ¨åŠ›ï¼š</strong> ä½“åŠ›â†’è„‘åŠ›ã€‚<br>
                            <strong>æ€»ç»“ï¼š</strong> ç§‘æŠ€æ¨åŠ¨è¦ç´ é‡ç»„ï¼Œä¿ƒè¿›å‘å±•ã€‚`,
                takeaways: [
                    "è®ºè¿°é¢˜å…¬å¼ï¼š<strong>è§‚ç‚¹ + åˆ†è®ºç‚¹ï¼ˆç´§æ‰£é¢˜ç›®å…³é”®è¯ï¼‰ + å²å®æ”¯æ’‘ + æ€»ç»“</strong>ã€‚"
                ]
            },
            {
                id: 3,
                year: "2015 é«˜è€ƒå†å²",
                title: "ç¬¬15é¢˜ï¼šå”ä»£å¸åˆ¶æ”¹é©",
                content: `<strong>ï¼ˆ1ï¼‰æŒ‡å‡ºå”ä»£å¸åˆ¶æ”¹é©çš„ä¸»è¦å†…å®¹ã€‚</strong><br>
                          <strong>ï¼ˆ2ï¼‰è¯´æ˜å”ä»£å¸åˆ¶æ”¹é©çš„æ„ä¹‰ã€‚</strong>`,
                oldAnswer: `ï¼ˆ1ï¼‰å†…å®¹ï¼šæ¨è¿›åè¿›ä½åˆ¶çš„è½¬å˜ï¼Œä¸ç”¨é’±å¸é‡é‡ä½“ç°é’±å¸ä»·å€¼\nï¼ˆ2ï¼‰æ„ä¹‰ï¼šå¼€å¯æ–°çš„è´§å¸ä½“ç³»ï¼Œæœ‰åˆ©äºç»æµçš„å‘å±•ï¼Œæ–¹ä¾¿æ—¥å¸¸è´§å¸çš„ä½¿ç”¨`,
                scoreInfo: "æ—§å¾—åˆ†ï¼šè‰¯å¥½",
                diagnosis: `1. <strong>æœ¯è¯­ä¸å‡†ï¼š</strong> åº”ä¸ºâ€œé€šå®/å…ƒå®ä½“åˆ¶â€ï¼ˆä¸å†ä»¥é‡é‡å‘½åï¼‰ã€‚<br>
                            2. <strong>æ·±åº¦ä¸å¤Ÿï¼š</strong> åº”æ‹”é«˜åˆ°â€œç¡®ç«‹äº†å†ä»£é“¸å¸èŒƒå¼â€ã€‚`,
                examinerNotes: [
                    "æŠ“ä½äº†åè¿›ä½åˆ¶ï¼Œæ–¹å‘æ­£ç¡®ã€‚",
                    "è¡¥å……â€œèŒƒå¼â€å’Œâ€œå•†å“ç»æµå‘å±•â€ä¼šæ›´å¥½ã€‚"
                ],
                stdAnswer: `<strong>ï¼ˆ1ï¼‰å†…å®¹ï¼š</strong> å¼€åˆ›â€œé€šå®/å…ƒå®â€ä½“åˆ¶ï¼›ç¡®ç«‹åè¿›ä½åˆ¶ï¼›ç»Ÿä¸€å¸åˆ¶ã€‚<br>
                            <strong>ï¼ˆ2ï¼‰æ„ä¹‰ï¼š</strong> ç»“æŸæ··ä¹±ï¼Œåˆ©äºå•†å“ç»æµï¼›ç¡®ç«‹åä¸–èŒƒå¼ï¼›æ–¹ä¾¿è®¡ç®—ã€‚`,
                takeaways: [
                    "ç»æµå²æ„ä¹‰ï¼šå¯¹å½“æ—¶ï¼ˆç»æµå‘å±•ï¼‰ã€å¯¹åä¸–ï¼ˆåˆ¶åº¦èŒƒå¼ï¼‰ã€å¯¹æ“ä½œï¼ˆä¾¿åˆ©ï¼‰ã€‚"
                ]
            },
            {
                id: 4,
                year: "2015 é«˜è€ƒå†å²",
                title: "ç¬¬16é¢˜ï¼šæŠ—æˆ˜å‰åå…šæ´¾åœ°ä½å˜åŒ–",
                content: `<strong>ï¼ˆ1ï¼‰æ¦‚æ‹¬æŒ‡å‡ºæŠ—æˆ˜èƒœåˆ©å‰åå„å…šæ´¾åœ°ä½å‘ç”Ÿçš„å˜åŒ–ã€‚</strong><br>
                          <strong>ï¼ˆ2ï¼‰åˆ†æå„å…šæ´¾åœ°ä½å˜åŒ–çš„åŸå› åŠå½±å“ã€‚</strong>`,
                oldAnswer: `ï¼ˆ1ï¼‰å˜åŒ–ï¼šæŠ—æ—¥æˆ˜äº‰æ—¶æœŸï¼Œå„å…šæ´¾äºå›½æ°‘å…šé¢†å¯¼ä¸‹ï¼ŒæŠ—æ—¥èƒœåˆ©ï¼Œå¤šæ•°å…šæ´¾åœ¨å®ªæ³•ä¸‹ä¸€å¾‹åœ°ä½å¹³ç­‰\nï¼ˆ2ï¼‰åŸå› ï¼šå›½å…±ä¸¤å…šå®åŠ›å‘ç”Ÿå·¨å¤§å˜åŒ–ï¼Œç¾å›½å’Œè‹è”åœ¨èƒŒåçš„å½±å“`,
                scoreInfo: "æ—§å¾—åˆ†ï¼šä¸¥é‡æ¼ç­”",
                diagnosis: `1. <strong>å®¡é¢˜å¤§å¿Œï¼š</strong> é¢˜ç›®é—®â€œåŸå› åŠ<strong style='color:red'>å½±å“</strong>â€ï¼Œä½ å®Œå…¨æ¼æ‰äº†â€œå½±å“â€ï¼<br>
                            2. <strong>åŸå› ä¸å…¨ï¼š</strong> å¿½è§†äº†å†…å› ï¼ˆæŠ—æˆ˜è´¡çŒ®ã€æ°‘å¿ƒï¼‰ã€‚`,
                examinerNotes: [
                    "ä¸¥é‡æ¼ç‚¹ï¼Œå®Œå…¨æœªå›ç­”â€œå½±å“â€ã€‚",
                    "åŸå› éƒ¨åˆ†å¿½è§†äº†å†…éƒ¨å› ç´ ã€‚"
                ],
                stdAnswer: `<strong>ï¼ˆ1ï¼‰å˜åŒ–ï¼š</strong> å›½æ°‘å…šä¸€å…šä¸“æ”¿ â†’ å„å…šæ´¾æ³•å¾‹ä¸Šå¹³ç­‰ã€‚<br>
                            <strong>ï¼ˆ2ï¼‰åŸå› ï¼š</strong> å›¢ç»“æŠ—æˆ˜åŠ›é‡å£®å¤§ï¼›ä¸­å…±å¢å¼ºï¼›æ°‘å¿ƒæ‰€å‘ï¼›å›½é™…åˆ¶çº¦ã€‚<br>
                            <strong>å½±å“ï¼š</strong> ä¿ƒæˆæ”¿åä¼šè®®ï¼›åˆ©äºæ°‘ä¸»æ”¿æ²»ï¼›ä¸ºæ–°ä¸­å›½å¥ åŸºï¼›æ‰“ç ´ä¸“æ”¿ã€‚`,
                takeaways: [
                    "çœ‹åˆ°â€œåŸå› åŠå½±å“â€ï¼Œå¿…é¡»åœ¨è‰ç¨¿çº¸ä¸Šåœˆå‡ºæ¥ï¼Œå¼ºåˆ¶åˆ†æ®µã€‚"
                ]
            },
            {
                id: 5,
                year: "2015 é«˜è€ƒå†å²",
                title: "ç¬¬17é¢˜ï¼šæˆ´é«˜ä¹ä¸æ³•å›½å¤å…´",
                content: `<strong>ï¼ˆ1ï¼‰æ¦‚æ‹¬æˆ´é«˜ä¹å·å¬æŠµæŠ—çš„ç†ç”±ã€‚</strong><br>
                          <strong>ï¼ˆ2ï¼‰æ€»ç»“æ³•å›½å¤å…´çš„å†å²ç»éªŒã€‚</strong><br>
                          <small style='color:#666'>ææ–™æç¤ºï¼šâ€œæ²¡æœ‰è¾“æ‰æˆ˜äº‰â€ã€â€œåºå¤§å¸å›½â€ã€â€œç›Ÿå‹â€ã€‚</small>`,
                oldAnswer: `ï¼ˆ1ï¼‰åŸå› ï¼šç»Ÿæ²»è€…éœ€è¦æ²»ç†åºå¤§çš„å¸å›½ï¼Œå–„äºåŠè¯«\nï¼ˆ2ï¼‰æ„ä¹‰ï¼šç»´æŠ¤å›½å®¶å®‰å®šï¼Œä¸ºåä»£æä¾›å‚è€ƒä»·å€¼ï¼Œæœ‰é‡è¦çš„æ–‡çŒ®ä»·å€¼`,
                scoreInfo: "æ—§å¾—åˆ†ï¼š0åˆ† (è·‘é¢˜)",
                diagnosis: `1. <strong>å¹»è§†ï¼š</strong> ç­”æˆäº†å¤ä»£å²æˆ–å²ä¹¦è¯„ä»·ã€‚<br>
                            2. <strong>è„±ç¦»ææ–™ï¼š</strong> å¿…é¡»ä¾æ®ææ–™é‡Œçš„â€œç›Ÿå‹â€ã€â€œæ®–æ°‘åœ°â€ä½œç­”ã€‚`,
                examinerNotes: [
                    "ä¸¥é‡å®¡é¢˜/çŸ¥è¯†ç‚¹é”™è¯¯ã€‚",
                    "å¿…é¡»ä¾æ®ææ–™ï¼šæˆ´é«˜ä¹æ¼”è®²å†…å®¹ã€‚"
                ],
                stdAnswer: `<strong>ï¼ˆ1ï¼‰ç†ç”±ï¼š</strong> èƒœè´¥æœªå®šï¼›æœ‰æ®–æ°‘åœ°åç›¾ï¼›æœ‰ç›Ÿå‹æ”¯æŒï¼›æ­£ä¹‰å¿…èƒœã€‚<br>
                            <strong>ï¼ˆ2ï¼‰ç»éªŒï¼š</strong> åšæŒç‹¬ç«‹ä¸»æƒï¼›ä¾é äººæ°‘ï¼›å›½é™…åˆä½œï¼›è°ƒæ•´ç­–ç•¥ã€‚`,
                takeaways: [
                    "ä¸æ‡‚èƒŒæ™¯ä¸è¦ç¼–ï¼Œç­”æ¡ˆå…¨åœ¨ææ–™é‡Œã€‚"
                ]
            },
            {
                id: 6,
                year: "2016 é«˜è€ƒå†å²",
                title: "ç¬¬13é¢˜ï¼šæ¸…ä¸­æœŸäººå£ä¸è¿‘ä»£ä¸»å¼ ",
                content: `<strong>ï¼ˆ1ï¼‰è¯´æ˜æ¸…ä¸­æœŸäººå£è†¨èƒ€çš„åŸå› åŠå½±å“ã€‚</strong><br>
                          <strong>ï¼ˆ2ï¼‰æ¦‚æ‹¬è¿‘ä»£å­¦è€…ä¸»å¼ å¹¶è¯„ä»·ã€‚</strong>`,
                oldAnswer: `åŸå› ï¼šæ”¿æ²»ç¨³å®šï¼Œé«˜äº§ä½œç‰©ã€‚å½±å“ï¼šåœŸåœ°ç´§å¼ ã€‚\nä¸»å¼ ï¼šè®¡ç”Ÿï¼Œæ”¹è‰¯å†œä¸šã€‚è¯„ä»·ï¼šå€Ÿé‰´ï¼Œç§»æ°‘ä¸å¯è¡Œã€‚`,
                scoreInfo: "æ—§å¾—åˆ†ï¼š18/25",
                diagnosis: `1. <strong>ç»†èŠ‚ä¸¢å¤±ï¼š</strong> æ¼æ‰â€œç”Ÿæ€ç ´åâ€ã€â€œäººå‡æ”¶å…¥ä¸‹é™â€ã€‚<br>
                            2. <strong>è¯„ä»·ç©ºæ³›ï¼š</strong> â€œæä¾›å€Ÿé‰´â€æ˜¯åºŸè¯ã€‚è¦å…·ä½“è¯„æå®ä¸šã€ç§»æ°‘çš„ä¼˜åŠ£ã€‚`,
                examinerNotes: [
                    "æ¼æ‰å†œä½œåˆ¶æ”¹è¿›ã€ç”Ÿæ€æ¶åŒ–ã€‚",
                    "è¯„ä»·è¿‡äºç¬¼ç»Ÿã€‚"
                ],
                stdAnswer: `<strong>ï¼ˆ1ï¼‰åŸå› ï¼š</strong> ç¨³å®šï¼›ç¨æ”¹ï¼›å¤ç§ï¼›é«˜äº§ä½œç‰©ï¼›è€•åœ°æ‰©å¤§ã€‚<br>
                            <strong>å½±å“ï¼š</strong> äººåœ°çŸ›ç›¾ï¼›ç”Ÿæ€æ¶åŒ–ï¼›æ”¶å…¥ä¸‹é™ï¼›æ¸¸æ‰‹å¥½é—²ï¼›æ°‘å˜ã€‚<br>
                            <strong>ï¼ˆ2ï¼‰è¯„ä»·ï¼š</strong> ç§»æ°‘ç¼“è§£ä½†ç ´ç¯ç”Ÿæ€ï¼›å®ä¸šæ²»æœ¬ä½†éœ€èµ„é‡‘ï¼›èŠ‚è‚²æ ¹æœ¬ä½†å—è§‚å¿µåˆ¶çº¦ã€‚`,
                takeaways: [
                    "æ¦‚æ‹¬é¢˜è¦åƒå‰¥æ´‹è‘±ï¼Œæ¯ä¸€å¥è¯éƒ½æ˜¯å¾—åˆ†ç‚¹ã€‚"
                ]
            },
            {
                id: 7,
                year: "2016 é«˜è€ƒå†å²",
                title: "ç¬¬14é¢˜ï¼šå¢æ¢­æ€æƒ³ä¸åˆ¶åº¦ï¼ˆå°è®ºæ–‡ï¼‰",
                content: `<strong>å›´ç»•â€œåˆ¶åº¦æ„æƒ³ä¸å®è·µâ€æ‹Ÿå®šè®ºé¢˜å¹¶é˜è¿°ã€‚</strong><br>
                          <small>å¢æ¢­åå¯¹ä»£è®®åˆ¶ï¼Œè®¤ä¸ºè‹±å›½äººé€‰å‡ºè®®å‘˜åå°±æ˜¯å¥´éš¶ã€‚</small>`,
                oldAnswer: `è‹±å›½å›ä¸»ç«‹å®ªï¼Œå›½ç‹ä¸–è¢­æ— æƒ...`,
                scoreInfo: "æ—§å¾—åˆ†ï¼š4/12",
                diagnosis: `1. <strong>æ ¼å¼é”™è¯¯ï¼š</strong> æœªå†™â€œè®ºé¢˜ï¼šxxxxâ€ã€‚<br>
                            2. <strong>ç¼ºä¹æ€è¾¨ï¼š</strong> åªå†™äº†è‹±å›½åˆ¶åº¦ï¼Œæœªç»“åˆå¢æ¢­è§‚ç‚¹çš„â€œç†æƒ³vsç°å®â€å†²çªã€‚`,
                examinerNotes: [
                    "æœªæ‹Ÿå®šè®ºé¢˜ã€‚",
                    "æœªåˆ†æå¢æ¢­æ€æƒ³ä¸ä»£è®®åˆ¶çš„çŸ›ç›¾ã€‚"
                ],
                stdAnswer: `<strong>è®ºé¢˜ï¼š</strong> å¢æ¢­äººæ°‘ä¸»æƒç†è®ºçš„ç†æƒ³æ€§ä¸ä»£è®®åˆ¶å®è·µçš„ç°å®æ€§ã€‚<br>
                            <strong>é˜è¿°ï¼š</strong> å¢æ¢­ä¸»å¼ ç›´æ¥æ°‘ä¸»ï¼ˆç†æƒ³æ€§ï¼‰åœ¨å¤§å›½éš¾å®ç°ï¼›ä»£è®®åˆ¶ï¼ˆç°å®æ€§ï¼‰è™½æœ‰ç¼ºé™·ä½†é€šè¿‡åˆ†æƒåˆ¶è¡¡é˜²æ­¢æš´æ”¿ã€‚<br>
                            <strong>ç»“è®ºï¼š</strong> ä»£è®®åˆ¶æ˜¯ç°ä»£æ”¿æ²»çš„ç°å®é€‰æ‹©ã€‚`,
                takeaways: [
                    "å°è®ºæ–‡å¿…å†™æ ‡é¢˜ã€‚",
                    "ä½“ç°â€œç†æƒ³ vs ç°å®â€çš„å¼ åŠ›ã€‚"
                ]
            }
        ];

        let currentIndex = 0;
        const STORAGE_KEY = 'history_training_progress';
        let progressData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        
        // æ¯æ—¥è®¡åˆ’åŠŸèƒ½å˜é‡
        let dailyGoal = 5;
        let sessionCount = 0; // æœ¬æ¬¡ä¼šè¯å·²åšé¢˜æ•°
        let sessionRecords = []; // è®°å½•æœ¬æ¬¡ä¼šè¯çš„é¢˜ç›®å’Œç»“æœ

        // å°†å‡½æ•°æŒ‚è½½åˆ° window å¯¹è±¡ä¸Šï¼Œä»¥ä¾¿ HTML æŒ‰é’®è°ƒç”¨
        window.startPractice = function() {
            // è·å–ç”¨æˆ·è®¾å®šçš„æ¯æ—¥é¢˜é‡
            const inputVal = document.getElementById('daily-goal-input').value;
            dailyGoal = parseInt(inputVal) || 5;
            sessionCount = 0;
            sessionRecords = [];

            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('practice-screen').classList.remove('hidden');
            document.getElementById('practice-screen').style.animation = 'fadeIn 0.5s';
            
            updateStats();
            loadQuestion(0);
        }

        function updateStats() {
            const masteredCount = Object.values(progressData).filter(status => status === 'mastered').length;
            document.getElementById('master-count').innerText = `å·²æŒæ¡: ${masteredCount}`;
            // æ˜¾ç¤ºæ ¼å¼ï¼šå½“å‰ç¬¬å‡ é¢˜ / æ€»æ•° (ä»Šæ—¥ç›®æ ‡: X)
            document.getElementById('progress-text').innerText = `${currentIndex + 1}/${questions.length} (ä»Šæ—¥ç›®æ ‡:${dailyGoal})`;
        }

        function loadQuestion(index) {
            currentIndex = index;
            const q = questions[index];

            updateStats();
            document.getElementById('progress-bar').style.width = `${((index + 1) / questions.length) * 100}%`;

            document.getElementById('q-year').innerText = q.year;
            document.getElementById('q-score-info').innerText = q.scoreInfo;
            document.getElementById('q-title').innerText = q.title;
            document.getElementById('q-content').innerHTML = q.content;
            document.getElementById('q-diagnosis').innerHTML = q.diagnosis;

            const statusBadge = document.getElementById('status-badge');
            statusBadge.className = 'status-badge'; 
            const historyStatus = progressData[q.id];
            
            if (historyStatus === 'mastered') {
                statusBadge.innerText = 'âœ… å·²æŒæ¡';
                statusBadge.classList.add('status-mastered');
                statusBadge.style.display = 'inline-block';
            } else if (historyStatus === 'review') {
                statusBadge.innerText = 'ğŸ”´ éœ€å¤ä¹ ';
                statusBadge.classList.add('status-review');
                statusBadge.style.display = 'inline-block';
            } else {
                statusBadge.style.display = 'none';
            }

            document.getElementById('user-input').value = '';
            document.getElementById('input-section').style.display = 'block';
            document.getElementById('review-section').style.display = 'none';
            document.getElementById('upload-status').innerText = '';

            document.getElementById('old-answer-display').innerText = q.oldAnswer;
            document.getElementById('std-answer-display').innerHTML = q.stdAnswer;
            
            document.getElementById('examiner-notes').innerHTML = q.examinerNotes.map(n => `<div>â€¢ ${n}</div>`).join('');
            document.getElementById('key-takeaways').innerHTML = q.takeaways.map(t => `<li>${t}</li>`).join('');

            window.scrollTo(0, 0);
        }

        window.submitAnswer = function() {
            const val = document.getElementById('user-input').value;
            if (!val.trim()) {
                alert("è¯·å…ˆè¾“å…¥ä¸€äº›å…³é”®è¯");
                return;
            }

            document.getElementById('new-answer-display').innerText = val;
            document.getElementById('input-section').style.display = 'none';
            document.getElementById('review-section').style.display = 'block';
            document.getElementById('review-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        window.markResult = async function(isMastered) {
            const q = questions[currentIndex];
            const status = isMastered ? 'mastered' : 'review';
            const statusText = isMastered ? 'âœ… å·²æŒæ¡' : 'ğŸ”´ éœ€å¤ä¹ ';
            
            // è®°å½•æœ¬æ¬¡ä¼šè¯æ•°æ®ï¼Œç”¨äºå‘é‚®ä»¶
            sessionRecords.push({
                title: q.title,
                status: statusText,
                questionId: q.id
            });
            sessionCount++;

            // 1. æœ¬åœ°ä¿å­˜
            progressData[q.id] = status;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(progressData));
            updateStats();

            // 2. äº‘ç«¯ä¿å­˜ (å¦‚æœå·²é…ç½®)
            if (isCloudEnabled && db) {
                const statusDiv = document.getElementById('upload-status');
                statusDiv.innerText = "â³ æ­£åœ¨ä¸Šä¼ æ•°æ®...";
                try {
                    await addDoc(collection(db, "exam_records"), {
                        userId: userId,
                        questionId: q.id,
                        questionTitle: q.title,
                        status: status, // mastered or review
                        timestamp: serverTimestamp(),
                        dateStr: new Date().toLocaleString()
                    });
                    statusDiv.innerText = "â˜ï¸ æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯";
                } catch (e) {
                    console.error("ä¸Šä¼ å¤±è´¥", e);
                    statusDiv.innerText = "âš ï¸ ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ä»Šæ—¥ç›®æ ‡æˆ–é¢˜ç›®åšå®Œ
            setTimeout(() => {
                if (sessionCount >= dailyGoal || currentIndex >= questions.length - 1) {
                    finishSession();
                } else {
                    window.nextQuestion();
                }
            }, 800);
        }

        window.skipQuestion = function() {
            window.nextQuestion();
        }

        window.nextQuestion = function() {
            if (currentIndex < questions.length - 1) {
                loadQuestion(currentIndex + 1);
            } else {
                finishSession();
            }
        }
        
        // ç»“æŸæœ¬æ¬¡ç‰¹è®­ï¼Œå±•ç¤ºç»“ç®—é¡µå¹¶å‘é€é‚®ä»¶
        function finishSession() {
            document.getElementById('practice-screen').classList.add('hidden');
            document.getElementById('completion-screen').classList.remove('hidden');
            
            // ç”Ÿæˆæ‘˜è¦HTML
            const summaryContainer = document.getElementById('session-summary-list');
            let summaryHTML = "";
            let emailContentText = ""; // çº¯æ–‡æœ¬å†…å®¹ç”¨äºé‚®ä»¶

            sessionRecords.forEach((record, index) => {
                summaryHTML += `
                    <div class="summary-item">
                        <span>${index + 1}. ${record.title}</span>
                        <strong>${record.status}</strong>
                    </div>
                `;
                emailContentText += `${index + 1}. ${record.title} - [${record.status}]\n`;
            });
            summaryContainer.innerHTML = summaryHTML;

            // è°ƒç”¨å‘é€é‚®ä»¶åŠŸèƒ½
            sendEmailReport(emailContentText);
        }

        // å‘é€é‚®ä»¶åŠŸèƒ½
        function sendEmailReport(content) {
            const statusDiv = document.getElementById('email-report-status');
            
            if (!sessionRecords.length) {
                statusDiv.innerText = "âš ï¸ æœ¬æ¬¡æœªåšé¢˜ï¼Œæ— æŠ¥å‘Šå‘é€ã€‚";
                return;
            }

            // å‡†å¤‡æ¨¡æ¿å‚æ•°
            // è¿™é‡Œå‡è®¾æ¨¡æ¿é‡Œæœ‰ä¸€ä¸ª {{message}} æˆ–ç±»ä¼¼çš„å˜é‡æ¥æ¥æ”¶ä¸»è¦å†…å®¹
            // æˆ‘ä»¬æ„é€ ä¸€ä¸ªåŒ…å«æ—¥æœŸå’Œè¯¦æƒ…çš„å­—ç¬¦ä¸²
            const todayStr = new Date().toLocaleString();
            const reportData = {
                to_name: "ç”¨æˆ·", // å¦‚æœæœ‰ç”¨æˆ·åå¯æ›¿æ¢
                message: `
[å†å²ç‰¹è®­æŠ¥å‘Š]
æ—¥æœŸ: ${todayStr}
ä»Šæ—¥ç›®æ ‡: ${dailyGoal}é¢˜
å®é™…å®Œæˆ: ${sessionRecords.length}é¢˜

è¯¦æƒ…:
${content}
                `
            };

            emailjs.send(EMAIL_CONFIG.serviceID, EMAIL_CONFIG.templateID, reportData)
                .then(function(response) {
                    console.log('SUCCESS!', response.status, response.text);
                    statusDiv.innerHTML = "âœ… é‚®ä»¶æŠ¥å‘Šå·²å‘é€æˆåŠŸï¼<br>è¯·æŸ¥æ”¶åŒ…å«ä»Šæ—¥é¢˜ç›®å’ŒæŒæ¡æƒ…å†µçš„é‚®ä»¶ã€‚";
                    statusDiv.style.background = "#dcfce7";
                    statusDiv.style.color = "#166534";
                }, function(error) {
                    console.log('FAILED...', error);
                    statusDiv.innerHTML = "âŒ é‚®ä»¶å‘é€å¤±è´¥ã€‚<br>è¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®ã€‚";
                    statusDiv.style.background = "#fee2e2";
                    statusDiv.style.color = "#991b1b";
                });
        }

        window.clearData = function() {
            if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰åšé¢˜è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem(STORAGE_KEY);
                progressData = {};
                alert('è®°å½•å·²é‡ç½®');
                location.reload();
            }
        }
    </script>
</body>
</html>
